# Outreach Engine (Python + FastAPI + APScheduler)

CSV-driven cold outreach engine with optional AI copy generation.

Key capabilities:
- SMTP sending (Gmail/Workspace) with async `aiosmtplib`
- IMAP parsing for replies and bounces
- APScheduler for sequenced follow‑ups (24h, 48h, 7d cutoff)
- Optional Gemini AI for email body generation (fallback to Jinja)
- SQLite (default) via SQLAlchemy; can switch to Postgres
- FastAPI app for unsubscribe, mailbox polling, and health checks


## Why this project
You provide a CSV of leads and the engine sends a daily‑capped batch of intro emails, then schedules follow‑ups if there’s no reply. Opt‑outs are respected via an unsubscribe link, and bounces/replies are detected via IMAP.


## Project structure
```
app/
  ai.py             # Gemini/Jinja body builder (subjects + bodies)
  config.py         # .env settings loader (Pydantic)
  csv_import.py     # CSV -> DB importer (header mapping + de-dup)
  db.py             # SQLAlchemy engine/session
  emailer.py        # Async SMTP sender (multipart or text)
  imap_listener.py  # IMAP parser for bounces and replies
  main.py           # FastAPI app (/unsubscribe, /mailbox/poll, /health)
  models.py         # ORM models (Contact, Suppressed)
  scheduler.py      # Jobs: daily intro + periodic follow‑ups
requirements.txt
.env.example
```


## Setup (local)
1) Create virtual environment and install deps
```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

2) Configure environment
```bash
cp .env.example .env
# Open .env and fill SMTP/IMAP and links
```
Notes:
- Use a Gmail App Password (or Workspace) for SMTP/IMAP.
- Keep secrets out of Git (this repo already has `.gitignore`).

3) Import your CSV
```bash
python run_import.py path/to/contacts.csv
```
CSV must have at least an `email` column. Optional mapping is applied (see CSV Mapping).

4) Run the API + scheduler
```bash
uvicorn app.main:app --reload --port 8000
```
Endpoints:
- `GET /health` → quick status
- `GET /unsubscribe?e=<email>` → adds to suppression list
- `POST /mailbox/poll` → check IMAP now (replies/bounces)


## .env configuration
All config is read via `app/config.py`.

Core
- `DATABASE_URL`: Default `sqlite:///./outreach.db`. For Postgres: `postgresql+psycopg2://user:pass@host:5432/db`.

App links
- `PORTFOLIO_URL`: Public portfolio link inserted in emails.
- `CV_URL`: Public CV/resume link inserted in emails (place resume on supabase storage or any other).
- `UNSUB_BASE_URL`: Base of unsubscribe link sent in emails (e.g., `http://localhost:8000/unsubscribe`).

Sender identity
- `FROM_EMAIL`: The mailbox you’re sending from.
- `FROM_NAME`: Display name used in From header.
- `REPLY_TO` (optional): Sets Reply‑To header if different from From.

SMTP (outbound)
- `SMTP_HOST`: e.g., `smtp.gmail.com`
- `SMTP_PORT`: `587` (STARTTLS) recommended
- `SMTP_USERNAME`: mailbox username
- `SMTP_PASSWORD`: mailbox password or app password

IMAP (inbound parsing)
- `IMAP_HOST`: e.g., `imap.gmail.com`
- `IMAP_PORT`: `993`
- `IMAP_USERNAME`: mailbox username
- `IMAP_PASSWORD`: mailbox password or app password

Cadence & caps
- `DAILY_CAP`: Max emails per run for each step.
- `PER_EMAIL_DELAY_SECONDS`: Base delay between consecutive sends.
- `JITTER_MIN`, `JITTER_MAX` (optional): Add random jitter seconds to each send (helps look more human).
- `TIMEZONE`: Scheduler timezone (default `Asia/Karachi`).

Follow‑up schedule (hours)
- `FU1_DELAY_HOURS`: After intro before follow‑up 1 (default 24).
- `FU2_DELAY_HOURS`: After FU1 before follow‑up 2 (default 48).
- `CUTOFF_DELAY_HOURS`: After FU2 before sign‑off (default 168 / 7 days).

AI (optional)
- `GEMINI_API_KEY`: If set, copy is generated by Gemini.
- `GEMINI_MODEL`: Default `gemini-1.5-pro` (or any supported model).


## Configuration examples
Gmail/Workspace
- Create an App Password (Google Account → Security → App passwords) and use it for both SMTP and IMAP.
- `SMTP_HOST=smtp.gmail.com`, `SMTP_PORT=587`, `IMAP_HOST=imap.gmail.com`, `IMAP_PORT=993`.

Postgres instead of SQLite
- Install driver: `pip install psycopg2-binary`.
- Set `DATABASE_URL=postgresql+psycopg2://user:pass@host:5432/dbname`.

Tuning deliverability
- Start conservative: `DAILY_CAP=100`, `PER_EMAIL_DELAY_SECONDS=25`.
- Enable DKIM/SPF/DMARC on your domain (Workspace strongly recommended).
- Keep emails short, plain‑text preferred, 1–2 links max.


## CSV header mapping
Importer is case‑insensitive and maps:
- `Email` → `email` (required)
- `First` → `first_name`
- `Last` → `last_name`
- `Company` → `company`
- `Company Type` → `company_focus`

Extra fields saved to `notes` JSON:
- `Title`, `Company Linkedin URL`, `Linkedin URL`, `Website`, `Country`, `Company Size`

Command:
```bash
python run_import.py path/to/your.csv
```


## Bulk import from csv/
Import every CSV file inside `csv/` into the database.

- Bash (macOS/Linux):
```bash
for f in csv/*.csv; do echo "Importing $f"; python run_import.py "$f"; done
```

- PowerShell (Windows):
```powershell
Get-ChildItem csv -Filter *.csv | ForEach-Object { python run_import.py $_.FullName }
```

- Helper script:
```bash
bash scripts/import_all_csv.sh
```

Git hygiene: All real CSVs in `csv/` are git-ignored; a commit-safe example is provided as `csv/sample.csv`.


## How the scheduler runs
Defined in `app/scheduler.py`:
- Daily intro batch at ~09:30 PKT (04:30 UTC), capped by `DAILY_CAP`.
- Follow‑ups evaluated hourly (FU1 after `FU1_DELAY_HOURS`, FU2 after `FU2_DELAY_HOURS`).
- Cutoff once per day after `CUTOFF_DELAY_HOURS`.

Note: A one‑time kick job is included (10s after startup) to help testing. Remove or comment that job in `app/scheduler.py` for production.


## API usage
Health
```bash
curl http://localhost:8000/health
```

Manual IMAP poll (replies/bounces)
```bash
curl -X POST http://localhost:8000/mailbox/poll
```

Unsubscribe link (added automatically in emails)
```
GET {UNSUB_BASE_URL}?e=<recipient-email>
```


## Using Gemini for copy
When `GEMINI_API_KEY` is set, `app/ai.py` drafts short plain‑text copy per step; Jinja fallback is used if the key is missing or the API fails. Subjects are built per step; a minimal signature/footer is appended automatically.


## Troubleshooting
- SMTP auth errors: confirm App Password and 2FA; check port 587 with STARTTLS.
- IMAP login blocked: ensure IMAP is enabled for the account; use App Password.
- Nothing gets sent: see logs; verify contacts have `status=no_sync` and not suppressed.
- High bounces: verify emails with a validator before import; bounces are auto‑suppressed.


## Urdu Quick Guide (.env)
- DATABASE_URL: SQLite by default; Postgres bhi use ho sakta hai.
- PORTFOLIO_URL, CV_URL: aap ki public links jo email me jayengi.
- FROM_EMAIL, FROM_NAME: jis inbox se email jayegi aur display name.
- SMTP_*: send karne ke liye server details (Gmail/Workspace ke sath App Password use karein).
- IMAP_*: replies/bounces read karne ke liye (same account ke IMAP creds).
- DAILY_CAP, PER_EMAIL_DELAY_SECONDS: roz kitni emails bhejni hain aur beech ka delay.
- FU1_DELAY_HOURS, FU2_DELAY_HOURS, CUTOFF_DELAY_HOURS: follow‑ups ka gap hours me.
- TIMEZONE: scheduler ka time zone (default Asia/Karachi).
- GEMINI_API_KEY, GEMINI_MODEL: AI copy on karne ke liye (optional).


## Notes and extensions
- Switch to HTML templates if needed; `emailer.py` already supports multipart.
- For multi‑inbox rotation, extend `send_email` to cycle credentials.
- To run as a service, use `systemd`/PM2 or Docker (not included here).


**Gmail SMTP Setup**
- Prerequisites: Gmail or Google Workspace mailbox with 2‑Step Verification enabled.
- Turn On 2‑Step Verification: Google Account → Security → 2‑Step Verification.
- Create App Password: Google Account → Security → App passwords (search “App passwords”).
- Generate: choose App “Mail” and your device (or “Other”), then Generate; copy the 16‑char password.
- Use In .env: set `SMTP_USERNAME` = your full email, `SMTP_PASSWORD` = the app password; use same pair for `IMAP_USERNAME`/`IMAP_PASSWORD`.
- SMTP Settings: `SMTP_HOST=smtp.gmail.com`, `SMTP_PORT=587` (STARTTLS). IMAP: `IMAP_HOST=imap.gmail.com`, `IMAP_PORT=993` (SSL).
- Enable IMAP In Gmail: Gmail → Settings → See all settings → Forwarding and POP/IMAP → Enable IMAP → Save changes.
- Workspace Admins: Admin Console → Apps → Google Workspace → Gmail → User settings → IMAP access = On; enforce 2‑Step Verification so users can create App Passwords.
- Deliverability: set up SPF, DKIM, and DMARC on your sending domain for best results.
- Troubleshooting: errors like “534‑5.7.9 Application‑specific password required” → ensure 2SV + App Password; “Username and Password not accepted” → re‑check creds and IMAP enabled; sometimes visiting `https://accounts.google.com/DisplayUnlockCaptcha` can help after first server sign‑in.
